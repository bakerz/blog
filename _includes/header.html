<div id="header">
  <div class="search-box m-lr-10 p-lr-10">
    <i class="icon-search"></i>
    <input type="text" class="search-btn p-0" placeholder="...">
    <div class="search-mask">
      <div class="result-box">
        <div class="search-box m-10 p-lr-10">
          <i class="icon-search"></i>
          <input type="text" class="search-input p-0" placeholder="...">
          <i class="icon-close search-close-btn cursor-pointer"></i>
        </div>
        <div class="type">文章</div>
        <ul class="res-post-group m-tb-8">
          {% for post in site.posts limit: 5 %}
          <li>
            <i class="icon-file"></i>
            <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
          </li>
          {% endfor %}
          <li>...</li>
        </ul>
        <div class="type">分类</div>
        <ul class="res-category-group m-tb-8">
          {% for category in site.categories %}
          <li>
            <i class="icon-folder-open"></i>
            <a href="{{ site.baseurl }}/categories#{{ category | first | slugify }}">{{ category | first }}</a>
          </li>
          {% endfor %}
        </ul>
        <div class="type">标签</div>
        <ul class="res-tag-group m-tb-8">
          {% assign tags = "" | split: "" %}
          {% for t in site.tags %}
          {% assign tags = tags | push: t[0] %}
          {% endfor %}
          {% assign sorted_tags = tags | sort_natural %}

          {% for tag in sorted_tags | limit: 5 %}
          <li>
            <i class="icon-tag"></i>
            <a href="{{ site.baseurl }}/tags#{{ tag | slugify }}">{{ tag }}</a>
          </li>
          {% endfor %}
          <li>...</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<script>
const URL = `{{ site.baseurl }}/datas/posts.json`;
let xhr, res;

if (window.XMLHttpRequest) {
  xhr = new XMLHttpRequest();
} else {
  // code for IE6, IE5
  xhr = new ActiveXObject("Microsoft.XMLHTTP");
}

xhr.open('GET', URL, true);
xhr.send();

xhr.onreadystatechange = () => {
  if (xhr.readyState === 4 && xhr.status === 200) {
    res = JSON.parse(xhr.responseText);
    console.log(res);
  }
}

// 显示搜索面板
const $search = document.querySelector('.search-mask');
const $input = document.querySelector('.search-input');
document.querySelector('.search-btn').addEventListener('click', () => {
  $search.style.display = 'block';
  $input.focus();
});

$input.addEventListener('input', (e) => {
  // console.log($input.value);
  const key = $input.value.toLowerCase();

  // posts
  let posts = res.posts.filter((item, index) => index < 11 && item.title.toLowerCase().includes(key));
  let postsHtml = '';
  posts.forEach((item, index) => {
    if (index === 10) {
      postsHtml += `<li>...</li>`
    } else {
      postsHtml += `<li>
        <i class="icon-file"></i>
        <a href="${item.url}">${item.title}</a></li>`;
    }
  });
  document.querySelector('.res-post-group').innerHTML = postsHtml || '<li class="no-data">No search results</li>';

  // categories
  let categories = res.categories.filter((item, index) => index < 11 && item.name.toLowerCase().includes(key));
  let categoriesHtml = '';
  categories.forEach((item, index) => {
    if (index === 10) {
      categoriesHtml += `<li>...</li>`
    } else {
      categoriesHtml += `<li>
        <i class="icon-folder-open"></i>
        <a href="${item.url}">${item.name}</a></li>`;
    }
  });
  document.querySelector('.res-category-group').innerHTML = categoriesHtml || '<li class="no-data">No search results</li>';

  // tags
  let tags = res.tags.filter((item, index) => index < 11 && item.name.toLowerCase().includes(key));
  let tagsHtml = '';
  tags.forEach((item, index) => {
    if (index === 10) {
      tagsHtml += `<li>...</li>`
    } else {
      tagsHtml += `<li>
        <i class="icon-tag"></i>
        <a href="${item.url}">${item.name}</a></li>`;
    }
  });
  document.querySelector('.res-tag-group').innerHTML = tagsHtml || '<li class="no-data">No search results</li>';
})

// 关闭搜索面板
document.querySelector('.result-box').addEventListener('click', (e) => {
  const $target = e.target;
  if ($target.className.includes('search-close-btn') || $target.tagName === 'A') {
    $search.style.display = 'none';
  }
})
document.addEventListener('keyup', (e) => {
  if (e.keyCode === 27) $search.style.display = 'none';
})
</script>